library(randomForest)
library(limma)
library(ggplot2)
library(pROC)
library(ggpubr)
library(vip)
library(pheatmap)
library(VennDiagram)
library(dplyr)
library(tidyr)

set.seed(123)
setwd("/Users/chris/Desktop/Keloid/RandomForest")

data <- read.table("normalize_unique.txt", header=TRUE, sep="\t", check.names=FALSE, row.names=1)
data_matrix <- as.matrix(data)
data_normalized <- normalizeBetweenArrays(data_matrix)

write.table(data.frame(ID=rownames(data_normalized), data_normalized), 
            file="normalize.txt", sep="\t", quote=FALSE, row.names=FALSE)

Normal <- scan("Normal.txt", what=character(), quiet=TRUE)
Keloid <- scan("Keloid.txt", what=character(), quiet=TRUE)

conNum <- length(Normal)
KeloidNum <- length(Keloid)
Type <- as.factor(c(rep("Normal", conNum), rep("Keloid", KeloidNum)))

data1 <- data_normalized[, Normal, drop=FALSE]
data2 <- data_normalized[, Keloid, drop=FALSE]
data_combined <- cbind(data1, data2)

user_genes <- c("ACOXL", "BARX1", "MIR202HG", "FAM156A", 
                "CHRNA7", "LINC00473", "SHISA3", "ZDHHC19")

available_genes <- user_genes[user_genes %in% rownames(data_combined)]

if (length(available_genes) < 3) {
  expression_means <- rowMeans(data_combined)
  threshold_value <- median(expression_means)
  data_filtered <- data_combined[expression_means > threshold_value, ]
} else {
  data_filtered <- data_combined[available_genes, ]
}

x <- t(data_filtered)
y <- Type

rf_model <- randomForest(x = x, y = y, 
                         ntree = 1000,
                         mtry = max(1, floor(sqrt(ncol(x)))),
                         importance = TRUE,
                         proximity = TRUE,
                         do.trace = 100)

print(rf_model)

importance_data <- importance(rf_model, type = 1)
importance_df <- data.frame(
  Gene = rownames(importance_data),
  Importance = importance_data[, 1]
)
importance_df <- importance_df[order(-importance_df$Importance), ]

write.table(importance_df, file="RF_user_genes_importance.txt", sep="\t", 
            quote=FALSE, row.names=FALSE)

error_data <- as.data.frame(rf_model$err.rate)
error_data$ntree <- 1:nrow(error_data)

error_long <- error_data %>%
  pivot_longer(cols = -ntree, names_to = "Error_Type", values_to = "Error_Rate")

stabilization_point <- 501

pdf("RF_user_genes_error_rate_ggplot.pdf", width=10, height=7)
ggplot(error_long, aes(x = ntree, y = Error_Rate, color = Error_Type)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_vline(xintercept = stabilization_point, linetype = "dashed", color = "red", size = 1.2, alpha = 0.7) +
  labs(title = "Random Forest Error Rate", x = "Number of Trees", y = "Error Rate") +
  theme_minimal()
dev.off()

pdf("RF_user_genes_error_rate_basic.pdf", width=8, height=6)
plot(rf_model)
legend("topright", colnames(rf_model$err.rate), col=1:3, lty=1:3)
dev.off()

pdf("RF_user_genes_importance.pdf", width=10, height=8)
varImpPlot(rf_model)
dev.off()

pdf("RF_user_genes_vip_plot.pdf", width=12, height=10)
vip(rf_model, num_features = min(20, ncol(x)), geom = "point", horizontal = FALSE) +
  theme_classic() +
  ggtitle("Gene Importance")
dev.off()

pdf("RF_user_genes_ROC_curve.pdf", width=8, height=8)
predictions <- predict(rf_model, type = "prob")
roc_obj <- roc(y, predictions[, "Keloid"])
plot(roc_obj, main = paste("ROC Curve (AUC =", round(auc(roc_obj), 3), ")"),
     col = "blue", lwd = 2)
abline(a=0, b=1, lty=2, col="red")
dev.off()

heatmap_data <- data_filtered
annotation_col <- data.frame(Group = y)
rownames(annotation_col) <- colnames(heatmap_data)

pdf("RF_user_genes_heatmap.pdf", width=10, height=8)
pheatmap(heatmap_data,
         scale = "row",
         annotation_col = annotation_col,
         show_colnames = FALSE,
         color = colorRampPalette(c("blue", "white", "red"))(50),
         main = "Expression Heatmap")
dev.off()

pdf("RF_user_genes_boxplot.pdf", width=14, height=10)
par(mfrow=c(2,4), mar=c(4,4,2,1))
for (gene in available_genes) {
  expr <- data_filtered[gene, ]
  boxplot(expr ~ y, main=gene, xlab="Group", ylab="Expression",
          col=c("lightblue", "lightcoral"))
}
dev.off()

pca_data <- t(data_filtered)
pca_result <- prcomp(pca_data, scale. = TRUE)
pca_df <- data.frame(PC1 = pca_result$x[,1], 
                     PC2 = pca_result$x[,2],
                     Group = y)

pdf("RF_user_genes_PCA_plot.pdf", width=8, height=6)
ggplot(pca_df, aes(x = PC1, y = PC2, color = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(level = 0.95) +
  theme_classic() +
  ggtitle("PCA Plot")
dev.off()

pdf("RF_user_genes_confusion_matrix.pdf", width=6, height=5)
pheatmap(rf_model$confusion[, 1:2], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE,
         display_numbers = TRUE,
         main = "Confusion Matrix")
dev.off()

saveRDS(rf_model, file = "random_forest_user_genes_model.rds")

user_genes_results <- data.frame(
  Gene = user_genes,
  In_Dataset = user_genes %in% rownames(data_combined)
)

write.table(user_genes_results, file="user_genes_detailed_results.txt", 
            sep="\t", quote=FALSE, row.names=FALSE)
